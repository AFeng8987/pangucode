<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.linlinjava.litemall.db.dao.GoodsMapper">

    <resultMap id="BaseResultMapDto" type="org.linlinjava.litemall.db.dto.LitemallGoodsDto">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="goods_sn" jdbcType="VARCHAR" property="goodsSn"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="category_id" jdbcType="INTEGER" property="categoryId"/>
        <result column="brand_id" jdbcType="INTEGER" property="brandId"/>
        <result column="gallery" jdbcType="VARCHAR" property="gallery"/>
        <result column="keywords" jdbcType="VARCHAR" property="keywords"/>
        <result column="brief" jdbcType="VARCHAR" property="brief"/>
        <result column="is_on_sale" jdbcType="BIT" property="isOnSale"/>
        <result column="sort_order" jdbcType="SMALLINT" property="sortOrder"/>
        <result column="pic_url" jdbcType="VARCHAR" property="picUrl"/>
        <result column="share_url" jdbcType="VARCHAR" property="shareUrl"/>
        <result column="is_new" jdbcType="BIT" property="isNew"/>
        <result column="is_hot" jdbcType="BIT" property="isHot"/>
        <result column="unit" jdbcType="VARCHAR" property="unit"/>
        <result column="counter_price" jdbcType="DECIMAL" property="counterPrice"/>
        <result column="retail_price" jdbcType="DECIMAL" property="retailPrice"/>
        <result column="detail" jdbcType="VARCHAR" property="detail"/>
        <result column="add_time" jdbcType="TIMESTAMP" property="addTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
        <result column="deleted" jdbcType="BIT" property="deleted"/>
        <result column="goods_code_id" jdbcType="INTEGER" property="goodsCodeId"/>
        <result column="goods_code" jdbcType="VARCHAR" property="goodsCode"/>
        <result column="freight" jdbcType="VARCHAR" property="freight"/>
        <result column="inventory" jdbcType="VARCHAR" property="inventory"/>
        <result column="sales" jdbcType="VARCHAR" property="sales"/>
    </resultMap>


    <select id="activityGoods" resultMap="BaseResultMapDto">
        SELECT
        g.id,
        gc.goods_code,
        g.`name`,
        g.pic_url,
        g.retail_price,
        g.is_on_sale,
        COALESCE ( sum( pf.goods_stock ), 0 ) AS inventory,
        g.sales AS sales
        FROM
        litemall_goods_activity ga
        LEFT JOIN litemall_goods g ON ga.goods_id = g.id
        LEFT JOIN litemall_product_factory pf ON pf.goods_code_id = g.goods_code_id
        LEFT JOIN litemall_order_goods og ON og.goods_id = g.id
        LEFT JOIN litemall_goods_code gc ON gc.id = g.goods_code_id
        WHERE
        ga.activity_id = #{activityId}
        <if test="goodsCode != null and goodsCode != ''">
            and gc.goods_code like #{goodsCode}
        </if>
        <if test="goodsName != null and goodsName != ''">
            and g.`name` like #{goodsName}
        </if>
        group by g.id
    </select>
    <select id="activityQueryGoods" resultMap="BaseResultMapDto">
        SELECT
        g.id,
        g.`name`,
        g.pic_url,
        g.is_on_sale,
        gc.goods_code
        FROM
        litemall_goods g
        LEFT JOIN litemall_goods_code gc ON gc.id = g.goods_code_id
        WHERE
        g.id not in (select goods_id from litemall_goods_activity WHERE activity_id =#{activityId})
        <if test="goodsCode != null and goodsCode != ''">
            and gc.goods_code like #{goodsCode}
        </if>
        <if test="goodsName != null and goodsName != ''">
            and g.`name` like #{goodsName}
        </if>
    </select>

    <select id="activityAPPGoods" resultMap="BaseResultMapDto">
        SELECT
        g.id,
        g.`name`,
        g.category_id,
        g.brand_id,
        g.gallery,
        g.keywords,
        g.brief,
        g.is_on_sale,
        g.sort_order,
        g.pic_url,
        g.share_url,
        g.is_new,
        g.is_hot,
        g.unit,
        g.counter_price,
        g.retail_price,
        g.add_time,
        g.update_time,
        g.deleted,
        g.goods_code_id,
        COALESCE ( sum( pf.goods_stock ), 0 ) AS inventory,
        COALESCE ( sum( og.id ), 0 ) AS sales
        FROM
        litemall_goods_activity ga
        LEFT JOIN litemall_goods g ON ga.goods_id = g.id
        LEFT JOIN litemall_product_factory pf ON pf.goods_code_id = g.goods_code_id
        LEFT JOIN litemall_order_goods og ON og.goods_id = g.id
        WHERE
        g.is_on_sale=true and
        ga.activity_id = #{activityId}
        <if test="goodsId != null">
            and g.id = #{goodsId}
        </if>
        <if test="goodsName != null and goodsName != ''">
            and g.`name` like #{goodsName}
        </if>
        group by g.id
    </select>
    <select id="queryGoodsList" resultType="java.util.Map">
        SELECT
        g.id,
        g.`name`,
        g.pic_url as picUrl,
        g.retail_price as retailPrice,
        g.counter_price as counterPrice,
        g.is_on_sale as isOnSale,
        g.is_hot as isHot,
        g.is_home as isHome,
        g.home_sort_order as homeSortOrder,
        gc.goods_code as goodsCode,
        c.`name` as categoryName
        FROM
        litemall_goods g
        LEFT JOIN litemall_goods_code gc ON gc.id = g.goods_code_id
        LEFT JOIN litemall_category c ON c.id = g.category_id
        WHERE
        g.deleted=false
        <if test="goodsId != null">
            and g.id = #{goodsId}
        </if>
        <if test="goodsName != null and goodsName != ''">
            and g.`name` like #{goodsName}
        </if>
        <if test="categoryName != null and categoryName != ''">
            and c.`name` like #{categoryName}
        </if>
        <if test="goodsCode != null and goodsCode != ''">
            and gc.goods_code like #{goodsCode}
        </if>
        <if test="isOnSale != null ">
            and g.is_on_sale = #{isOnSale}
        </if>
        <if test="isHome != null">
            and g.is_home = #{isHome}
            order by g.home_sort_order asc
        </if>
        <if test="isHome == null">
            order by g.update_time desc
        </if>


    </select>
    <select id="queryHotGoodsList" resultType="java.util.Map">
        SELECT
        g.id,
        g.`name`,
        g.pic_url as picUrl,
        g.retail_price as retailPrice,
        g.counter_price as counterPrice,
        g.is_on_sale as isOnSale,
        g.is_hot as isHot,
        gc.goods_code as goodsCode
        FROM
        litemall_goods g
        LEFT JOIN litemall_goods_code gc ON gc.id = g.goods_code_id
        WHERE
        g.deleted=false and  g.is_hot = true
        <if test="goodsName != null and goodsName != ''">
            and g.`name` like #{goodsName}
        </if>
        <if test="goodsCode != null and goodsCode != ''">
            and gc.goods_code like #{goodsCode}
        </if>
        order by g.update_time desc
    </select>
</mapper>
